---
- name: Train Model & Prep For Deployments
  become: yes
  become_user: "{{ ansible_user }}"
  ansible.builtin.shell: |
    echo "=== Starting MLOps Training ==="
    set -e

    echo "=== Creating new virtualenv ==="
    python3 -m venv venv
    . venv/bin/activate

    pip install --upgrade pip
    pip install -r requirements.txt

    echo "=== DVC pull ==="
    dvc remote remove mylocal || true
    dvc remote add -d -f mylocal /tmp/dvc_store
    dvc pull

    echo "=== Linking MLflow history ==="
    rm -rf mlruns || true
    ln -s /home/{{ ansible_user }}/mlflow_history mlruns

    echo "=== Running Training Script ==="
    python3 train.py

    echo "=== Preparing latest_model directory ==="
    rm -rf mlruns/latest_model || true
    rm -rf ml_model || true
    mkdir ml_model

    echo "=== Locating latest model.pkl ==="
    LATEST_LINE=$(find /home/{{ ansible_user }}/mlflow_history -name "model.pkl" -type f -printf "%T@ %p\n" | sort -n | tail -1)

    if [ -z "$LATEST_LINE" ]; then
        echo "ERROR: No model.pkl found. Aborting."
        exit 1
    fi

    LATEST_PKL_PATH=$(echo "$LATEST_LINE" | cut -d' ' -f2-)
    echo "Found latest model at: $LATEST_PKL_PATH"

    ARTIFACT_DIR=$(dirname "$LATEST_PKL_PATH")
    echo "Copying from artifact dir: $ARTIFACT_DIR"

    cp -rv "$ARTIFACT_DIR"/* ml_model/
  args:
    chdir: /home/{{ ansible_user }}/project_workspace
